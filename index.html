<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ad Generator</title>
  <!-- Google Fonts - Curated selection for ads -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Montserrat:ital,wght@0,400;0,500;0,600;0,700;0,800;0,900;1,400;1,500;1,600;1,700;1,800;1,900&family=Oswald:wght@400;500;600;700&family=Bebas+Neue&family=Poppins:ital,wght@0,400;0,500;0,600;0,700;0,800;0,900;1,400;1,500;1,600;1,700;1,800;1,900&family=Roboto:ital,wght@0,400;0,500;0,700;0,900;1,400;1,500;1,700;1,900&family=Open+Sans:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400;1,500;1,600;1,700;1,800&family=Lato:ital,wght@0,400;0,700;0,900;1,400;1,700;1,900&family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;0,800;0,900;1,400;1,500;1,600;1,700;1,800;1,900&family=Raleway:ital,wght@0,400;0,500;0,600;0,700;0,800;0,900;1,400;1,500;1,600;1,700;1,800;1,900&family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Archivo+Black&family=Anton&family=Barlow+Condensed:ital,wght@0,400;0,500;0,600;0,700;0,800;0,900;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0b;
      --bg-secondary: #0f0f10;
      --bg-tertiary: #141416;
      --bg-input: #1a1a1c;
      --bg-hover: #222224;
      --border: #1e1e20;
      --border-light: #2a2a2d;
      --text-primary: #e4e4e7;
      --text-secondary: #71717a;
      --text-muted: #3f3f46;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --accent-glow: rgba(59, 130, 246, 0.15);
      --success: #10b981;
      --panel-width: 260px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Top toolbar */
    .toolbar {
      height: 44px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 16px;
      gap: 16px;
      flex-shrink: 0;
    }

    .toolbar-brand {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .toolbar-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: 0.02em;
    }

    .toolbar-divider {
      width: 1px;
      height: 24px;
      background: var(--border);
    }

    .toolbar-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .toolbar-btn {
      background: transparent;
      border: 1px solid transparent;
      color: var(--text-secondary);
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
    }

    .toolbar-btn:hover {
      background: var(--bg-hover);
      border-color: var(--border-light);
      color: var(--text-primary);
    }

    .toolbar-btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
      box-shadow: 0 0 20px var(--accent-glow);
    }

    .toolbar-btn.primary:hover {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
    }

    .toolbar-spacer {
      flex: 1;
    }

    .toolbar-dims {
      font-size: 11px;
      font-family: 'SF Mono', Monaco, monospace;
      color: var(--text-muted);
      background: var(--bg-tertiary);
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid var(--border);
    }

    /* Main layout */
    .main-layout {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* Panels */
    .panel {
      width: var(--panel-width);
      min-width: var(--panel-width);
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel.right {
      border-right: none;
      border-left: 1px solid var(--border);
    }

    .panel-content {
      flex: 1;
      overflow-y: auto;
    }

    /* Sections */
    .section {
      border-bottom: 1px solid var(--border);
    }

    .section:last-child {
      border-bottom: none;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      cursor: pointer;
      user-select: none;
      transition: background 0.1s;
    }

    .section-header:hover {
      background: var(--bg-tertiary);
      border-left: 2px solid var(--accent);
      padding-left: 10px;
    }

    .section-title {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .section-toggle {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      transition: transform 0.15s;
    }

    .section.collapsed .section-toggle {
      transform: rotate(-90deg);
    }

    .section-body {
      padding: 8px 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .section.collapsed .section-body {
      display: none;
    }

    /* Inputs */
    input[type="text"],
    input[type="number"],
    select {
      background: var(--bg-input);
      border: 1px solid transparent;
      border-radius: 4px;
      padding: 6px 8px;
      color: var(--text-primary);
      font-size: 12px;
      font-family: inherit;
      transition: all 0.1s;
      width: 100%;
    }

    input[type="text"]:hover,
    input[type="number"]:hover,
    select:hover {
      border-color: var(--border-light);
    }

    input[type="text"]:focus,
    input[type="number"]:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-glow);
    }

    input[type="number"] {
      -moz-appearance: textfield;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
    }

    select {
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8' viewBox='0 0 8 8'%3E%3Cpath fill='%23969696' d='M1.5 2.5L4 5.5L6.5 2.5'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 8px center;
      padding-right: 24px;
    }

    /* Property row */
    .prop-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .prop-label {
      font-size: 11px;
      color: var(--text-secondary);
      min-width: 60px;
      flex-shrink: 0;
    }

    .prop-value {
      flex: 1;
      min-width: 0;
    }

    .prop-row-2col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }

    /* Size presets */
    .size-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 4px;
    }

    .size-btn {
      background: var(--bg-input);
      border: 1px solid transparent;
      border-radius: 4px;
      padding: 6px 8px;
      color: var(--text-secondary);
      font-size: 10px;
      cursor: pointer;
      transition: all 0.1s;
      text-align: left;
    }

    .size-btn:hover {
      border-color: var(--border-light);
      color: var(--text-primary);
    }

    .size-btn.active {
      border-color: var(--accent);
      background: var(--accent-glow);
      color: var(--text-primary);
      box-shadow: 0 0 12px var(--accent-glow);
    }

    .size-btn .dims {
      font-weight: 600;
      font-size: 11px;
      display: block;
      font-family: 'SF Mono', Monaco, monospace;
    }

    /* Custom size */
    .size-input-row {
      display: grid;
      grid-template-columns: 1fr 12px 1fr;
      gap: 4px;
      align-items: center;
      margin-top: 4px;
    }

    .size-input-row span {
      text-align: center;
      color: var(--text-muted);
      font-size: 11px;
    }

    .size-input-row input {
      text-align: center;
      padding: 5px 4px;
      font-size: 11px;
      min-width: 0;
    }

    /* Color input */
    .color-input {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    input[type="color"] {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      padding: 0;
      background: none;
    }

    input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 1px;
    }

    input[type="color"]::-webkit-color-swatch {
      border: 1px solid var(--border-light);
      border-radius: 3px;
    }

    .color-input input[type="text"] {
      width: 70px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 11px;
      text-transform: uppercase;
    }

    /* Slider */
    .slider-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      flex: 1;
      height: 3px;
      background: var(--bg-input);
      border-radius: 2px;
      cursor: pointer;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.15s;
      box-shadow: 0 0 8px var(--accent-glow);
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      background: var(--accent-hover);
      transform: scale(1.1);
    }

    .slider-value {
      font-size: 10px;
      color: var(--text-muted);
      font-family: 'SF Mono', Monaco, monospace;
      min-width: 32px;
      text-align: right;
    }

    /* Text block */
    .text-block {
      background: var(--bg-tertiary);
      border-radius: 4px;
      margin-bottom: 6px;
    }

    .text-block:last-child {
      margin-bottom: 0;
    }

    .text-block-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 8px;
      cursor: pointer;
    }

    .text-block-header:hover {
      background: var(--bg-hover);
      border-radius: 4px 4px 0 0;
    }

    .text-block-title {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .text-block-hint {
      font-size: 9px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .text-block-body {
      padding: 6px 8px 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .text-block.collapsed .text-block-body {
      display: none;
    }

    .text-block.collapsed .text-block-header {
      border-radius: 4px;
    }

    /* Mini controls */
    .mini-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
    }

    .mini-row select {
      padding: 4px 20px 4px 6px;
      font-size: 10px;
    }

    /* Canvas area */
    .canvas-area {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #050506;
      background-image:
        radial-gradient(circle at 50% 50%, rgba(59, 130, 246, 0.03) 0%, transparent 50%);
      position: relative;
      overflow: hidden;
    }

    .canvas-area::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
    }

    .canvas-container {
      position: relative;
      z-index: 1;
    }

    canvas {
      display: block;
      box-shadow:
        0 0 0 1px rgba(255, 255, 255, 0.05),
        0 8px 40px rgba(0, 0, 0, 0.6),
        0 0 80px rgba(59, 130, 246, 0.08);
      border-radius: 2px;
    }

    .canvas-container {
      max-width: calc(100vw - var(--panel-width) * 2 - 80px);
      max-height: calc(100vh - 100px);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .canvas-container canvas {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .canvas-info {
      position: absolute;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-secondary);
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 10px;
      color: var(--text-muted);
      font-family: 'SF Mono', Monaco, monospace;
      border: 1px solid var(--border);
      letter-spacing: 0.05em;
    }

    /* Scrollbar */
    .panel-content::-webkit-scrollbar {
      width: 8px;
    }

    .panel-content::-webkit-scrollbar-track {
      background: transparent;
    }

    .panel-content::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
      border: 2px solid var(--bg-secondary);
    }

    .panel-content::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* Icons */
    .icon {
      width: 14px;
      height: 14px;
      stroke: currentColor;
      stroke-width: 1.5;
      fill: none;
    }

    .icon-sm {
      width: 10px;
      height: 10px;
    }

    /* Reset button */
    .reset-btn {
      width: 100%;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 6px 10px;
      color: var(--text-secondary);
      font-size: 10px;
      font-family: inherit;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.15s;
      margin-bottom: 4px;
    }

    .reset-btn:hover {
      background: var(--bg-hover);
      border-color: var(--border-light);
      color: var(--text-primary);
    }

    .reset-btn svg {
      stroke: currentColor;
      stroke-width: 1.5;
      fill: none;
    }
  </style>
</head>
<body>
  <!-- Top Toolbar -->
  <div class="toolbar">
    <div class="toolbar-brand">
      <span class="toolbar-title">AD STUDIO</span>
    </div>
    <div class="toolbar-divider"></div>
    <div class="toolbar-group">
      <button class="toolbar-btn" onclick="resetDefaults()">
        <svg class="icon" viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
        Reset
      </button>
    </div>
    <div class="toolbar-spacer"></div>
    <span class="toolbar-dims" id="canvasDims">1200 × 800</span>
    <div class="toolbar-divider"></div>
    <button class="toolbar-btn primary" onclick="downloadAd()">
      <svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7,10 12,15 17,10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Export PNG
    </button>
  </div>

  <div class="main-layout">
    <!-- Left Panel -->
    <aside class="panel">
      <div class="panel-content">
        <!-- Canvas Size -->
        <div class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <span class="section-title">Canvas</span>
            <div class="section-toggle">
              <svg class="icon-sm" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><polyline points="6,9 12,15 18,9"/></svg>
            </div>
          </div>
          <div class="section-body">
            <div class="size-grid">
              <button class="size-btn" data-w="1200" data-h="800">
                <span class="dims">1200×800</span>Landscape
              </button>
              <button class="size-btn" data-w="1080" data-h="1080">
                <span class="dims">1080×1080</span>Square
              </button>
              <button class="size-btn active" data-w="1200" data-h="628">
                <span class="dims">1200×628</span>Reddit Feed
              </button>
              <button class="size-btn" data-w="1080" data-h="1920">
                <span class="dims">1080×1920</span>Story
              </button>
              <button class="size-btn" data-w="1200" data-h="675">
                <span class="dims">1200×675</span>Reddit Alt
              </button>
              <button class="size-btn" data-w="1600" data-h="900">
                <span class="dims">1600×900</span>16:9
              </button>
              <button class="size-btn" data-w="1456" data-h="180">
                <span class="dims">1456×180</span>Banner
              </button>
              <button class="size-btn" data-w="800" data-h="418">
                <span class="dims">800×418</span>Twitter
              </button>
            </div>
            <div class="size-input-row">
              <input type="number" id="width" value="1200">
              <span>×</span>
              <input type="number" id="height" value="628">
            </div>
          </div>
        </div>

        <!-- Colors -->
        <div class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <span class="section-title">Colors</span>
            <div class="section-toggle">
              <svg class="icon-sm" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><polyline points="6,9 12,15 18,9"/></svg>
            </div>
          </div>
          <div class="section-body">
            <div class="prop-row">
              <span class="prop-label">Background</span>
              <div class="color-input">
                <input type="color" id="bgColorPicker" value="#0033FF">
                <input type="text" id="bgColor" value="#0033FF" maxlength="7">
              </div>
            </div>
            <div class="prop-row">
              <span class="prop-label">Text</span>
              <div class="color-input">
                <input type="color" id="textColorPicker" value="#ffffff">
                <input type="text" id="textColor" value="#FFFFFF" maxlength="7">
              </div>
            </div>
          </div>
        </div>

        <!-- Typography -->
        <div class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <span class="section-title">Typography</span>
            <div class="section-toggle">
              <svg class="icon-sm" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><polyline points="6,9 12,15 18,9"/></svg>
            </div>
          </div>
          <div class="section-body">
            <button class="reset-btn" onclick="resetTypography(); event.stopPropagation();">
              <svg class="icon-sm" viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
              Reset to font defaults
            </button>
            <div class="prop-row">
              <span class="prop-label">Font</span>
              <select id="fontFamily" class="prop-value">
                <optgroup label="Display / Impact">
                  <option value="Bebas Neue">Bebas Neue</option>
                  <option value="Anton">Anton</option>
                  <option value="Archivo Black">Archivo Black</option>
                  <option value="Oswald">Oswald</option>
                  <option value="Barlow Condensed">Barlow Condensed</option>
                </optgroup>
                <optgroup label="Modern Sans">
                  <option value="Inter" selected>Inter</option>
                  <option value="Montserrat">Montserrat</option>
                  <option value="Poppins">Poppins</option>
                  <option value="Space Grotesk">Space Grotesk</option>
                  <option value="DM Sans">DM Sans</option>
                  <option value="Raleway">Raleway</option>
                </optgroup>
                <optgroup label="Classic Sans">
                  <option value="Roboto">Roboto</option>
                  <option value="Open Sans">Open Sans</option>
                  <option value="Lato">Lato</option>
                </optgroup>
                <optgroup label="Serif">
                  <option value="Playfair Display">Playfair Display</option>
                </optgroup>
                <optgroup label="System">
                  <option value="Helvetica">Helvetica</option>
                  <option value="Impact">Impact</option>
                  <option value="Arial Black">Arial Black</option>
                  <option value="Arial">Arial</option>
                </optgroup>
              </select>
            </div>
            <div class="prop-row-2col">
              <select id="fontWeight">
                <option value="400">Regular</option>
                <option value="500">Medium</option>
                <option value="600">SemiBold</option>
                <option value="700" selected>Bold</option>
                <option value="800">ExtraBold</option>
                <option value="900">Black</option>
              </select>
              <select id="fontStyle">
                <option value="normal" selected>Normal</option>
                <option value="italic">Italic</option>
              </select>
            </div>
            <div class="prop-row">
              <span class="prop-label">Transform</span>
              <select id="textTransform" class="prop-value">
                <option value="none">None</option>
                <option value="uppercase">Uppercase</option>
                <option value="capitalize">Title Case</option>
              </select>
            </div>
            <div class="prop-row">
              <span class="prop-label">Tracking</span>
              <div class="slider-row prop-value">
                <input type="range" id="letterSpacing" min="-0.05" max="0.15" step="0.005" value="-0.02">
                <span class="slider-value" id="letterSpacingVal">0%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Canvas Area -->
    <main class="canvas-area">
      <div class="canvas-container">
        <canvas id="canvas"></canvas>
      </div>
      <div class="canvas-info" id="canvasInfo">1200 × 628 px</div>
    </main>

    <!-- Right Panel -->
    <aside class="panel right">
      <div class="panel-content">
        <!-- Content -->
        <div class="section">
          <div class="section-header" onclick="toggleSection(this)">
            <span class="section-title">Content</span>
            <div class="section-toggle">
              <svg class="icon-sm" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none"><polyline points="6,9 12,15 18,9"/></svg>
            </div>
          </div>
          <div class="section-body">
            <!-- Intro -->
            <div class="text-block">
              <div class="text-block-header" onclick="toggleTextBlock(this)">
                <span class="text-block-title">Intro</span>
                <span class="text-block-hint">Qualifier</span>
              </div>
              <div class="text-block-body">
                <input type="text" id="introText" value="WordPress User?">
                <div class="mini-row">
                  <select id="introWeight">
                    <option value="400">Regular</option>
                    <option value="500" selected>Medium</option>
                    <option value="600">SemiBold</option>
                    <option value="700">Bold</option>
                  </select>
                  <select id="introTransform">
                    <option value="none" selected>As typed</option>
                    <option value="uppercase">UPPER</option>
                  </select>
                </div>
                <div class="slider-row">
                  <span class="prop-label">Size</span>
                  <input type="range" id="introSize" min="0.25" max="0.7" step="0.01" value="0.38">
                  <span class="slider-value" id="introSizeVal">0.38×</span>
                </div>
              </div>
            </div>

            <!-- Headline -->
            <div class="text-block">
              <div class="text-block-header" onclick="toggleTextBlock(this)">
                <span class="text-block-title">Headline</span>
                <span class="text-block-hint">Primary</span>
              </div>
              <div class="text-block-body">
                <input type="text" id="headlineText1" value="Stop Paying for" placeholder="Line 1">
                <input type="text" id="headlineText2" value="Bandwidth" placeholder="Line 2">
                <div class="slider-row">
                  <span class="prop-label">Size</span>
                  <input type="range" id="headlineSize" min="0.08" max="0.22" step="0.005" value="0.15">
                  <span class="slider-value" id="headlineSizeVal">15%</span>
                </div>
              </div>
            </div>

            <!-- Offer -->
            <div class="text-block">
              <div class="text-block-header" onclick="toggleTextBlock(this)">
                <span class="text-block-title">Offer</span>
                <span class="text-block-hint">CTA</span>
              </div>
              <div class="text-block-body">
                <input type="text" id="offerText" value="FREE: 100 GB / Mo">
                <div class="mini-row">
                  <select id="offerWeight">
                    <option value="400">Regular</option>
                    <option value="600">SemiBold</option>
                    <option value="700">Bold</option>
                    <option value="800" selected>ExtraBold</option>
                    <option value="900">Black</option>
                  </select>
                  <select id="offerTransform">
                    <option value="none">As typed</option>
                    <option value="uppercase" selected>UPPER</option>
                  </select>
                </div>
                <div class="slider-row">
                  <span class="prop-label">Size</span>
                  <input type="range" id="offerSize" min="0.4" max="1.1" step="0.01" value="0.65">
                  <span class="slider-value" id="offerSizeVal">0.65×</span>
                </div>
              </div>
            </div>

            <!-- Legend -->
            <div class="text-block">
              <div class="text-block-header" onclick="toggleTextBlock(this)">
                <span class="text-block-title">Legend</span>
                <span class="text-block-hint">Fine print</span>
              </div>
              <div class="text-block-body">
                <input type="text" id="legendText" value="Cloudflare-level speed without touching DNS">
                <div class="mini-row">
                  <select id="legendWeight">
                    <option value="400" selected>Regular</option>
                    <option value="500">Medium</option>
                    <option value="600">SemiBold</option>
                    <option value="700">Bold</option>
                  </select>
                  <select id="legendTransform">
                    <option value="none" selected>As typed</option>
                    <option value="uppercase">UPPER</option>
                  </select>
                </div>
                <div class="slider-row">
                  <span class="prop-label">Size</span>
                  <input type="range" id="legendSize" min="0.15" max="0.5" step="0.01" value="0.22">
                  <span class="slider-value" id="legendSizeVal">0.22×</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    // Toggle section collapse
    function toggleSection(header) {
      header.parentElement.classList.toggle('collapsed');
    }

    function toggleTextBlock(header) {
      header.parentElement.classList.toggle('collapsed');
    }

    // Global defaults (canvas, colors, content text)
    const globalDefaults = {
      width: 1200,
      height: 628,
      bgColor: '#0033FF',
      textColor: '#FFFFFF',
      introText: 'WordPress User?',
      headlineText1: 'Stop Paying for',
      headlineText2: 'Bandwidth',
      offerText: 'FREE: 100 GB / Mo',
      legendText: 'Cloudflare-level speed without touching DNS'
    };

    // Font-specific typography presets
    const fontPresets = {
      // Display / Impact fonts
      'Bebas Neue': {
        fontWeight: '400', fontStyle: 'normal', textTransform: 'uppercase', letterSpacing: 0.04,
        introSize: 0.32, introWeight: '400', introTransform: 'uppercase',
        headlineSize: 0.18, offerSize: 0.55, offerWeight: '400', offerTransform: 'uppercase',
        legendSize: 0.20, legendWeight: '400', legendTransform: 'uppercase'
      },
      'Anton': {
        fontWeight: '400', fontStyle: 'normal', textTransform: 'uppercase', letterSpacing: 0.02,
        introSize: 0.30, introWeight: '400', introTransform: 'uppercase',
        headlineSize: 0.17, offerSize: 0.52, offerWeight: '400', offerTransform: 'uppercase',
        legendSize: 0.18, legendWeight: '400', legendTransform: 'uppercase'
      },
      'Archivo Black': {
        fontWeight: '400', fontStyle: 'normal', textTransform: 'uppercase', letterSpacing: 0.01,
        introSize: 0.28, introWeight: '400', introTransform: 'uppercase',
        headlineSize: 0.14, offerSize: 0.48, offerWeight: '400', offerTransform: 'uppercase',
        legendSize: 0.18, legendWeight: '400', legendTransform: 'none'
      },
      'Oswald': {
        fontWeight: '700', fontStyle: 'normal', textTransform: 'uppercase', letterSpacing: 0.02,
        introSize: 0.32, introWeight: '400', introTransform: 'uppercase',
        headlineSize: 0.16, offerSize: 0.55, offerWeight: '700', offerTransform: 'uppercase',
        legendSize: 0.20, legendWeight: '400', legendTransform: 'none'
      },
      'Barlow Condensed': {
        fontWeight: '700', fontStyle: 'normal', textTransform: 'uppercase', letterSpacing: 0.03,
        introSize: 0.34, introWeight: '500', introTransform: 'uppercase',
        headlineSize: 0.18, offerSize: 0.58, offerWeight: '800', offerTransform: 'uppercase',
        legendSize: 0.22, legendWeight: '400', legendTransform: 'none'
      },

      // Modern Sans fonts
      'Inter': {
        fontWeight: '700', fontStyle: 'normal', textTransform: 'none', letterSpacing: -0.02,
        introSize: 0.38, introWeight: '500', introTransform: 'none',
        headlineSize: 0.15, offerSize: 0.65, offerWeight: '800', offerTransform: 'uppercase',
        legendSize: 0.22, legendWeight: '400', legendTransform: 'none'
      },
      'Montserrat': {
        fontWeight: '700', fontStyle: 'normal', textTransform: 'none', letterSpacing: -0.01,
        introSize: 0.35, introWeight: '500', introTransform: 'none',
        headlineSize: 0.14, offerSize: 0.60, offerWeight: '800', offerTransform: 'uppercase',
        legendSize: 0.20, legendWeight: '400', legendTransform: 'none'
      },
      'Poppins': {
        fontWeight: '700', fontStyle: 'normal', textTransform: 'none', letterSpacing: -0.01,
        introSize: 0.36, introWeight: '500', introTransform: 'none',
        headlineSize: 0.14, offerSize: 0.58, offerWeight: '700', offerTransform: 'uppercase',
        legendSize: 0.20, legendWeight: '400', legendTransform: 'none'
      },
      'Space Grotesk': {
        fontWeight: '700', fontStyle: 'normal', textTransform: 'none', letterSpacing: -0.02,
        introSize: 0.36, introWeight: '500', introTransform: 'none',
        headlineSize: 0.15, offerSize: 0.62, offerWeight: '700', offerTransform: 'uppercase',
        legendSize: 0.22, legendWeight: '400', legendTransform: 'none'
      },
      'DM Sans': {
        fontWeight: '700', fontStyle: 'normal', textTransform: 'none', letterSpacing: -0.01,
        introSize: 0.36, introWeight: '500', introTransform: 'none',
        headlineSize: 0.15, offerSize: 0.60, offerWeight: '700', offerTransform: 'uppercase',
        legendSize: 0.22, legendWeight: '400', legendTransform: 'none'
      },
      'Raleway': {
        fontWeight: '700', fontStyle: 'normal', textTransform: 'none', letterSpacing: 0.01,
        introSize: 0.34, introWeight: '500', introTransform: 'none',
        headlineSize: 0.14, offerSize: 0.58, offerWeight: '800', offerTransform: 'uppercase',
        legendSize: 0.20, legendWeight: '400', legendTransform: 'none'
      },

      // Classic Sans fonts
      'Roboto': {
        fontWeight: '700', fontStyle: 'normal', textTransform: 'none', letterSpacing: 0,
        introSize: 0.36, introWeight: '500', introTransform: 'none',
        headlineSize: 0.15, offerSize: 0.60, offerWeight: '900', offerTransform: 'uppercase',
        legendSize: 0.22, legendWeight: '400', legendTransform: 'none'
      },
      'Open Sans': {
        fontWeight: '700', fontStyle: 'normal', textTransform: 'none', letterSpacing: 0,
        introSize: 0.36, introWeight: '500', introTransform: 'none',
        headlineSize: 0.14, offerSize: 0.58, offerWeight: '800', offerTransform: 'uppercase',
        legendSize: 0.22, legendWeight: '400', legendTransform: 'none'
      },
      'Lato': {
        fontWeight: '700', fontStyle: 'normal', textTransform: 'none', letterSpacing: 0.01,
        introSize: 0.36, introWeight: '400', introTransform: 'none',
        headlineSize: 0.15, offerSize: 0.60, offerWeight: '900', offerTransform: 'uppercase',
        legendSize: 0.22, legendWeight: '400', legendTransform: 'none'
      },

      // Serif
      'Playfair Display': {
        fontWeight: '700', fontStyle: 'normal', textTransform: 'none', letterSpacing: 0,
        introSize: 0.32, introWeight: '400', introTransform: 'none',
        headlineSize: 0.14, offerSize: 0.55, offerWeight: '800', offerTransform: 'uppercase',
        legendSize: 0.20, legendWeight: '400', legendTransform: 'none'
      },

      // System fonts
      'Helvetica': {
        fontWeight: '700', fontStyle: 'normal', textTransform: 'none', letterSpacing: -0.01,
        introSize: 0.36, introWeight: '400', introTransform: 'none',
        headlineSize: 0.15, offerSize: 0.62, offerWeight: '700', offerTransform: 'uppercase',
        legendSize: 0.22, legendWeight: '400', legendTransform: 'none'
      },
      'Impact': {
        fontWeight: '400', fontStyle: 'normal', textTransform: 'uppercase', letterSpacing: 0.02,
        introSize: 0.30, introWeight: '400', introTransform: 'uppercase',
        headlineSize: 0.16, offerSize: 0.50, offerWeight: '400', offerTransform: 'uppercase',
        legendSize: 0.18, legendWeight: '400', legendTransform: 'uppercase'
      },
      'Arial Black': {
        fontWeight: '400', fontStyle: 'normal', textTransform: 'uppercase', letterSpacing: 0.01,
        introSize: 0.28, introWeight: '400', introTransform: 'uppercase',
        headlineSize: 0.13, offerSize: 0.45, offerWeight: '400', offerTransform: 'uppercase',
        legendSize: 0.18, legendWeight: '400', legendTransform: 'none'
      },
      'Arial': {
        fontWeight: '700', fontStyle: 'normal', textTransform: 'none', letterSpacing: 0,
        introSize: 0.36, introWeight: '400', introTransform: 'none',
        headlineSize: 0.15, offerSize: 0.60, offerWeight: '700', offerTransform: 'uppercase',
        legendSize: 0.22, legendWeight: '400', legendTransform: 'none'
      }
    };

    // Track which typography fields have been manually overridden
    const overrides = new Set();
    const typographyFields = [
      'fontWeight', 'fontStyle', 'textTransform', 'letterSpacing',
      'introSize', 'introWeight', 'introTransform',
      'headlineSize', 'offerSize', 'offerWeight', 'offerTransform',
      'legendSize', 'legendWeight', 'legendTransform'
    ];

    // Get current font preset
    function getCurrentPreset() {
      const fontFamily = document.getElementById('fontFamily').value;
      return fontPresets[fontFamily] || fontPresets['Inter'];
    }

    // Apply font preset to non-overridden fields
    function applyFontPreset(clearOverrides = false) {
      if (clearOverrides) overrides.clear();

      const preset = getCurrentPreset();

      typographyFields.forEach(field => {
        if (!overrides.has(field) && preset[field] !== undefined) {
          const el = document.getElementById(field);
          if (el) el.value = preset[field];
        }
      });
    }

    // Mark field as overridden when user changes it
    function markOverride(fieldId) {
      if (typographyFields.includes(fieldId)) {
        overrides.add(fieldId);
      }
    }

    // Reset typography to font defaults
    function resetTypography() {
      overrides.clear();
      applyFontPreset();
      generateAd();
    }

    // Size presets
    document.querySelectorAll('.size-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('width').value = btn.dataset.w;
        document.getElementById('height').value = btn.dataset.h;
        generateAd();
      });
    });

    // Sync color pickers
    function syncColors(pickerId, textId) {
      const picker = document.getElementById(pickerId);
      const text = document.getElementById(textId);

      picker.addEventListener('input', () => {
        text.value = picker.value.toUpperCase();
      });

      text.addEventListener('input', () => {
        let val = text.value;
        if (!val.startsWith('#')) val = '#' + val;
        if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
          picker.value = val;
        }
      });
    }

    syncColors('bgColorPicker', 'bgColor');
    syncColors('textColorPicker', 'textColor');

    // Deselect presets on custom size change
    ['width', 'height'].forEach(id => {
      document.getElementById(id).addEventListener('input', () => {
        document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
      });
    });

    // Update displays
    function updateDisplays() {
      const w = document.getElementById('width').value;
      const h = document.getElementById('height').value;

      document.getElementById('introSizeVal').textContent =
        parseFloat(document.getElementById('introSize').value).toFixed(2) + '×';
      document.getElementById('headlineSizeVal').textContent =
        Math.round(parseFloat(document.getElementById('headlineSize').value) * 100) + '%';
      document.getElementById('offerSizeVal').textContent =
        parseFloat(document.getElementById('offerSize').value).toFixed(2) + '×';
      document.getElementById('legendSizeVal').textContent =
        parseFloat(document.getElementById('legendSize').value).toFixed(2) + '×';
      document.getElementById('letterSpacingVal').textContent =
        Math.round(parseFloat(document.getElementById('letterSpacing').value) * 100) + '%';
      document.getElementById('canvasDims').textContent = `${w} × ${h}`;
      document.getElementById('canvasInfo').textContent = `${w} × ${h} px`;
    }

    // Apply text transform
    function applyTransform(text, transform) {
      if (!text) return text;
      switch (transform) {
        case 'uppercase': return text.toUpperCase();
        case 'capitalize': return text.replace(/\b\w/g, c => c.toUpperCase());
        default: return text;
      }
    }

    // Fit text to width
    function fitText(text, maxWidth, fontSize, fontWeight, fontStyle, fontFamily, letterSpacing) {
      if (!text) return fontSize;
      let size = fontSize;
      const spacing = size * letterSpacing;
      ctx.font = `${fontStyle} ${fontWeight} ${size}px "${fontFamily}"`;

      while ((ctx.measureText(text).width + (text.length - 1) * spacing) > maxWidth && size > 8) {
        size -= 1;
        ctx.font = `${fontStyle} ${fontWeight} ${size}px "${fontFamily}"`;
      }
      return size;
    }

    // Draw text with letter spacing
    function drawText(text, x, y, fontSize, letterSpacing) {
      if (!text) return;
      const spacing = fontSize * letterSpacing;

      if (spacing === 0) {
        ctx.fillText(text, x, y);
        return;
      }

      const totalWidth = ctx.measureText(text).width + (text.length - 1) * spacing;
      let currentX = x - totalWidth / 2;

      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const charWidth = ctx.measureText(char).width;
        ctx.fillText(char, currentX + charWidth / 2, y);
        currentX += charWidth + spacing;
      }
    }

    // Device pixel ratio for sharp display
    const dpr = window.devicePixelRatio || 1;

    // We use two canvases:
    // - Main canvas: scaled up for sharp display on high-DPI screens
    // - Export canvas: actual logical pixel size for export
    const exportCanvas = document.createElement('canvas');
    const exportCtx = exportCanvas.getContext('2d');

    function generateAd() {
      updateDisplays();

      const width = parseInt(document.getElementById('width').value) || 1200;
      const height = parseInt(document.getElementById('height').value) || 800;

      // Display canvas: scaled for screen DPI
      canvas.width = width * dpr;
      canvas.height = height * dpr;
      canvas.style.width = width + 'px';
      canvas.style.height = height + 'px';

      // Export canvas: actual logical size
      exportCanvas.width = width;
      exportCanvas.height = height;

      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      exportCtx.imageSmoothingEnabled = true;
      exportCtx.imageSmoothingQuality = 'high';

      const bgColor = document.getElementById('bgColor').value;
      const textColor = document.getElementById('textColor').value;
      const fontFamily = document.getElementById('fontFamily').value;
      const globalWeight = document.getElementById('fontWeight').value;
      const globalStyle = document.getElementById('fontStyle').value;
      const globalTransform = document.getElementById('textTransform').value;
      const letterSpacing = parseFloat(document.getElementById('letterSpacing').value);

      const headlineFactor = parseFloat(document.getElementById('headlineSize').value);
      const introFactor = parseFloat(document.getElementById('introSize').value);
      const offerFactor = parseFloat(document.getElementById('offerSize').value);
      const legendFactor = parseFloat(document.getElementById('legendSize').value);

      const introWeight = document.getElementById('introWeight').value;
      const introTransform = document.getElementById('introTransform').value;
      const offerWeight = document.getElementById('offerWeight').value;
      const offerTransform = document.getElementById('offerTransform').value;
      const legendWeight = document.getElementById('legendWeight').value;
      const legendTransform = document.getElementById('legendTransform').value;

      let introText = document.getElementById('introText').value;
      let headlineText1 = document.getElementById('headlineText1').value;
      let headlineText2 = document.getElementById('headlineText2').value;
      let offerText = document.getElementById('offerText').value;
      let legendText = document.getElementById('legendText').value;

      introText = applyTransform(introText, introTransform !== 'none' ? introTransform : globalTransform);
      headlineText1 = applyTransform(headlineText1, globalTransform);
      headlineText2 = applyTransform(headlineText2, globalTransform);
      offerText = applyTransform(offerText, offerTransform !== 'none' ? offerTransform : globalTransform);
      legendText = applyTransform(legendText, legendTransform !== 'none' ? legendTransform : globalTransform);

      const baseHeadlineSize = height * headlineFactor;
      const introSize = baseHeadlineSize * introFactor;
      const offerSize = baseHeadlineSize * offerFactor;
      const legendSize = baseHeadlineSize * legendFactor;

      const maxTextWidth = width * 0.88;

      const introFontSize = fitText(introText, maxTextWidth, introSize,
        introWeight !== 'normal' ? introWeight : globalWeight, globalStyle, fontFamily, letterSpacing);
      const headline1FontSize = fitText(headlineText1, maxTextWidth, baseHeadlineSize,
        globalWeight, globalStyle, fontFamily, letterSpacing);
      const headline2FontSize = fitText(headlineText2, maxTextWidth, baseHeadlineSize,
        globalWeight, globalStyle, fontFamily, letterSpacing);
      const offerFontSize = fitText(offerText, maxTextWidth, offerSize,
        offerWeight, globalStyle, fontFamily, letterSpacing);
      const legendFontSize = fitText(legendText, maxTextWidth, legendSize,
        legendWeight !== 'normal' ? legendWeight : globalWeight, globalStyle, fontFamily, letterSpacing);

      const gapIntroToHeadline = baseHeadlineSize * 0.25;
      const gapHeadlineLines = baseHeadlineSize * 0.08;
      const gapHeadlineToOffer = baseHeadlineSize * 0.75;
      const gapOfferToLegend = baseHeadlineSize * 0.45;

      const elements = [];
      let contentHeight = 0;

      if (introText) {
        elements.push({
          type: 'intro',
          text: introText,
          fontSize: introFontSize,
          weight: introWeight !== 'normal' ? introWeight : globalWeight
        });
        contentHeight += introFontSize;
        if (headlineText1 || headlineText2) contentHeight += gapIntroToHeadline;
      }

      if (headlineText1) {
        elements.push({
          type: 'headline1',
          text: headlineText1,
          fontSize: headline1FontSize,
          weight: globalWeight
        });
        contentHeight += headline1FontSize;
      }

      if (headlineText2) {
        if (headlineText1) contentHeight += gapHeadlineLines;
        elements.push({
          type: 'headline2',
          text: headlineText2,
          fontSize: headline2FontSize,
          weight: globalWeight
        });
        contentHeight += headline2FontSize;
      }

      if (offerText) {
        if (headlineText1 || headlineText2) contentHeight += gapHeadlineToOffer;
        elements.push({
          type: 'offer',
          text: offerText,
          fontSize: offerFontSize,
          weight: offerWeight
        });
        contentHeight += offerFontSize;
      }

      if (legendText) {
        if (offerText) contentHeight += gapOfferToLegend;
        else if (headlineText1 || headlineText2) contentHeight += gapHeadlineToOffer;
        elements.push({
          type: 'legend',
          text: legendText,
          fontSize: legendFontSize,
          weight: legendWeight !== 'normal' ? legendWeight : globalWeight
        });
        contentHeight += legendFontSize;
      }

      // Render function for a given context and scale
      function render(targetCtx, scale) {
        targetCtx.save();
        targetCtx.scale(scale, scale);

        // Draw background
        targetCtx.fillStyle = bgColor;
        targetCtx.fillRect(0, 0, width, height);

        // Optical center
        const opticalOffset = height * 0.04;
        let currentY = (height - contentHeight) / 2 - opticalOffset;

        // Draw text
        targetCtx.fillStyle = textColor;
        targetCtx.textAlign = 'center';
        targetCtx.textBaseline = 'top';

        elements.forEach((el, index) => {
          targetCtx.font = `${globalStyle} ${el.weight} ${el.fontSize}px "${fontFamily}"`;

          if (letterSpacing !== 0) {
            // Draw text with letter spacing
            const spacing = el.fontSize * letterSpacing;
            const text = el.text;
            if (text) {
              const totalWidth = targetCtx.measureText(text).width + (text.length - 1) * spacing;
              let charX = width / 2 - totalWidth / 2;
              for (let i = 0; i < text.length; i++) {
                const char = text[i];
                const charWidth = targetCtx.measureText(char).width;
                targetCtx.fillText(char, charX + charWidth / 2, currentY);
                charX += charWidth + spacing;
              }
            }
          } else {
            targetCtx.fillText(el.text, width / 2, currentY);
          }

          currentY += el.fontSize;

          const next = elements[index + 1];
          if (el.type === 'intro' && next) {
            currentY += gapIntroToHeadline;
          } else if (el.type === 'headline1' && next?.type === 'headline2') {
            currentY += gapHeadlineLines;
          } else if ((el.type === 'headline1' || el.type === 'headline2') && next?.type === 'offer') {
            currentY += gapHeadlineToOffer;
          } else if ((el.type === 'headline1' || el.type === 'headline2') && next?.type === 'legend') {
            currentY += gapHeadlineToOffer;
          } else if (el.type === 'offer' && next?.type === 'legend') {
            currentY += gapOfferToLegend;
          }
        });

        targetCtx.restore();
      }

      // Render to display canvas (scaled for DPI)
      render(ctx, dpr);

      // Render to export canvas (1:1 pixels)
      render(exportCtx, 1);
    }

    // Embed pHYs chunk into PNG for correct display size on high-DPI screens
    // Higher DPI = smaller display size = pixel-perfect rendering
    function embedPngDpi(dataUrl, dpi) {
      const base64 = dataUrl.split(',')[1];
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }

      // Convert DPI to pixels per meter (PNG uses meters)
      const ppm = Math.round(dpi / 0.0254);

      // Build pHYs chunk (21 bytes total: 4 length + 4 type + 9 data + 4 crc)
      const chunk = new Uint8Array(21);
      const view = new DataView(chunk.buffer);

      // Length of data section (9 bytes)
      view.setUint32(0, 9, false);

      // Chunk type: "pHYs"
      chunk[4] = 0x70; chunk[5] = 0x48; chunk[6] = 0x59; chunk[7] = 0x73;

      // X and Y pixels per unit (meter)
      view.setUint32(8, ppm, false);
      view.setUint32(12, ppm, false);

      // Unit specifier: 1 = meter
      chunk[16] = 1;

      // CRC32 of type + data
      let crc = 0xFFFFFFFF;
      for (let i = 4; i < 17; i++) {
        let byte = chunk[i];
        for (let j = 0; j < 8; j++) {
          const bit = (byte ^ crc) & 1;
          crc >>>= 1;
          if (bit) crc ^= 0xEDB88320;
          byte >>>= 1;
        }
      }
      view.setUint32(17, (crc ^ 0xFFFFFFFF) >>> 0, false);

      // Find IDAT chunk and insert pHYs before it
      let pos = 8; // Skip PNG signature
      while (pos < bytes.length) {
        const len = (bytes[pos] << 24) | (bytes[pos+1] << 16) | (bytes[pos+2] << 8) | bytes[pos+3];
        const type = String.fromCharCode(bytes[pos+4], bytes[pos+5], bytes[pos+6], bytes[pos+7]);

        if (type === 'IDAT') {
          const result = new Uint8Array(bytes.length + 21);
          result.set(bytes.slice(0, pos), 0);
          result.set(chunk, pos);
          result.set(bytes.slice(pos), pos + 21);

          let str = '';
          for (let i = 0; i < result.length; i++) str += String.fromCharCode(result[i]);
          return 'data:image/png;base64,' + btoa(str);
        }
        pos += 12 + len;
      }
      return dataUrl;
    }

    function downloadAd() {
      const link = document.createElement('a');
      const w = parseInt(document.getElementById('width').value);
      const h = parseInt(document.getElementById('height').value);

      // Export at logical size with high DPI for pixel-perfect display
      // 72 DPI × devicePixelRatio = effective DPI for 1:1 pixel mapping
      const effectiveDpi = 72 * dpr;
      const pngData = embedPngDpi(exportCanvas.toDataURL('image/png'), effectiveDpi);

      link.download = `ad-${w}x${h}.png`;
      link.href = pngData;
      link.click();
    }

    function resetDefaults() {
      // Reset global defaults
      Object.keys(globalDefaults).forEach(key => {
        const el = document.getElementById(key);
        if (el) {
          el.value = globalDefaults[key];
          if (key === 'bgColor') document.getElementById('bgColorPicker').value = globalDefaults[key];
          if (key === 'textColor') document.getElementById('textColorPicker').value = globalDefaults[key];
        }
      });

      // Reset font to Inter
      document.getElementById('fontFamily').value = 'Inter';

      // Clear overrides and apply font preset
      overrides.clear();
      applyFontPreset();

      document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
      document.querySelector('.size-btn[data-w="1200"][data-h="628"]').classList.add('active');

      generateAd();
    }

    // Font loading cache to avoid redundant loads
    const loadedFonts = new Set();

    async function ensureFontLoaded(fontFamily) {
      if (loadedFonts.has(fontFamily)) return;

      if (document.fonts) {
        const weights = ['400', '500', '600', '700', '800', '900'];
        await Promise.all(
          weights.map(w => document.fonts.load(`${w} 48px "${fontFamily}"`).catch(() => {}))
        );
      }
      loadedFonts.add(fontFamily);
    }

    // Wrap generateAd to ensure font is loaded
    const originalGenerateAd = generateAd;
    generateAd = async function() {
      const fontFamily = document.getElementById('fontFamily').value;
      await ensureFontLoaded(fontFamily);
      originalGenerateAd();
    };

    // Set up live update listeners
    document.querySelectorAll('input, select').forEach(input => {
      input.addEventListener('input', (e) => {
        const id = e.target.id;

        // When font changes, apply preset to non-overridden fields
        if (id === 'fontFamily') {
          applyFontPreset();
        }
        // Track typography overrides
        else if (typographyFields.includes(id)) {
          markOverride(id);
        }

        generateAd();
      });
    });

    // Initial render
    document.fonts.ready.then(() => generateAd());
  </script>
</body>
</html>
